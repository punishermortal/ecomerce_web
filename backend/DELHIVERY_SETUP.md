# Delhivery API Integration Setup

## Overview

NextBloom is integrated with Delhivery for automated delivery management. When an order is placed, a shipment is automatically created with Delhivery.

## Setup Instructions

### 1. Get Delhivery API Credentials

1. Sign up for a Delhivery account at https://www.delhivery.com
2. Log in to your Delhivery dashboard
3. Go to **Settings** > **API** or **Developer Tools**
4. Generate an API token
5. Note down your API token and warehouse/pickup location details

### 2. Configure Environment Variables

Add the following to your `backend/.env` file:

```env
# Delhivery API Configuration
DELHIVERY_API_TOKEN=your_delhivery_api_token_here
DELHIVERY_ENABLED=True

# Pickup Location Details (Your Warehouse)
DELHIVERY_PICKUP_NAME=NextBloom
DELHIVERY_PICKUP_PHONE=+919876543210
DELHIVERY_PICKUP_ADDRESS=Your Warehouse Address, Street, Area
DELHIVERY_PICKUP_CITY=Mumbai
DELHIVERY_PICKUP_STATE=Maharashtra
DELHIVERY_PICKUP_PINCODE=400001
DELHIVERY_PICKUP_LOCATION=your_pickup_location_code  # Optional, if you have multiple locations
DELHIVERY_WAREHOUSE_NAME=NextBloom Warehouse  # Optional
```

### 3. API Endpoints Used

- **Create Shipment**: `POST https://track.delhivery.com/api/p/create`
- **Track Shipment**: `GET https://track.delhivery.com/api/packages/json/`
- **Cancel Shipment**: `POST https://track.delhivery.com/api/packages/json/`

### 4. How It Works

1. **Order Placement**: When a customer places an order:
   - Order is created in the database
   - Delhivery shipment is automatically created
   - Tracking ID (waybill) is stored in the order
   - Delivery status is updated

2. **Payment Methods**:
   - **COD (Cash on Delivery)**: Delhivery will collect payment on delivery
   - **Prepaid (Razorpay)**: Payment is already collected, Delhivery delivers without collecting

3. **Tracking**: 
   - Tracking ID is automatically generated by Delhivery
   - Customers can track their orders using the tracking ID
   - Admin can refresh delivery status from Delhivery

### 5. Package Weight

- Default weight per item: **500 grams (0.5 kg)**
- Total package weight is calculated as: `number of items Ã— 500g`
- You can customize this in `backend/orders/delivery.py`:
  ```python
  DEFAULT_PACKAGE_WEIGHT = 500  # Change this value
  ```

### 6. Testing

1. **Test Mode**: Delhivery provides test credentials for development
2. **Test Order**: Create a test order and verify:
   - Shipment is created in Delhivery
   - Tracking ID is received
   - Status is updated correctly

### 7. Admin Panel Features

- **View Orders**: See all orders with Delhivery tracking IDs
- **Track Orders**: Click on tracking ID to open Delhivery tracking page
- **Refresh Status**: Bulk action to refresh delivery status from Delhivery
- **Update Status**: Manually update order status if needed

### 8. Error Handling

- If Delhivery API fails, order is still created
- Delivery status will show "Pending Manual Entry"
- Admin can manually update tracking ID later
- Errors are logged for debugging

### 9. Common Issues

**Issue**: "Delhivery integration not enabled"
- **Solution**: Set `DELHIVERY_ENABLED=True` in `.env`

**Issue**: "API token not configured"
- **Solution**: Add `DELHIVERY_API_TOKEN=your_token` in `.env`

**Issue**: "Shipment creation failed"
- **Solution**: 
  - Check API token is valid
  - Verify pickup location details
  - Check Delhivery API status
  - Review error logs

### 10. Delhivery Dashboard

- Log in to Delhivery dashboard to:
  - View all shipments
  - Track deliveries
  - Manage pickup schedules
  - View reports and analytics
  - Manage COD collections

### 11. Support

- Delhivery Support: https://www.delhivery.com/support
- API Documentation: https://delhivery.freshdesk.com
- Contact Delhivery for:
  - API token issues
  - Pickup scheduling
  - Delivery issues
  - COD collection queries

## Environment Variables Summary

```env
# Required
DELHIVERY_API_TOKEN=your_api_token
DELHIVERY_ENABLED=True

# Pickup Location (Required)
DELHIVERY_PICKUP_NAME=Your Company Name
DELHIVERY_PICKUP_PHONE=+919876543210
DELHIVERY_PICKUP_ADDRESS=Your Address
DELHIVERY_PICKUP_CITY=Your City
DELHIVERY_PICKUP_STATE=Your State
DELHIVERY_PICKUP_PINCODE=123456

# Optional
DELHIVERY_PICKUP_LOCATION=location_code
DELHIVERY_WAREHOUSE_NAME=Warehouse Name
```

## Next Steps

1. Configure Delhivery API credentials
2. Set up pickup location details
3. Test with a sample order
4. Monitor deliveries in admin panel
5. Set up automated pickup schedules with Delhivery

